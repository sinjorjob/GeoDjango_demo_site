{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>GeodjangoDemoSite</title>

  <!-- Bootstrap Core CSS -->
  <link href="{% static 'startbootstrap-stylish-portfolio-gh-pages/vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">


  <!-- Custom Fonts -->
  <link href="{% static 'startbootstrap-stylish-portfolio-gh-pages/vendor/fontawesome-free/css/all.min.css' %}" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">
  <link href="{% static 'startbootstrap-stylish-portfolio-gh-pages/vendor/simple-line-icons/css/simple-line-icons.css' %}" rel="stylesheet">

  <!-- Custom CSS -->
  <link href="{% static 'startbootstrap-stylish-portfolio-gh-pages/css/stylish-portfolio.min.css' %}" rel="stylesheet">

</head>

<body id="page-top">

  <!-- Navigation -->
  <a class="menu-toggle rounded" href="#">
    <i class="fas fa-bars"></i>
  </a>
  <nav id="sidebar-wrapper">
    <ul class="sidebar-nav">
      <li class="sidebar-brand">
        <a class="js-scroll-trigger" href="#page-top">Geodjango Demo Site</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger" href="#page-top">ホーム</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger" href="#about">このサイトについて</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger" href="#services">構成要素</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger" href="#function">機能概要</a>
      </li>
      <li class="sidebar-nav-item">
        <a class="js-scroll-trigger" href="#map">避難所MAP</a>
      </li>
    </ul>
  </nav>

  <!-- Header -->
  <header class="masthead d-flex">
    <div class="container text-center my-auto">
      <h1 class="mb-1">GeoDjango Demo Site</h1>
      <h3 class="mb-5">
        <em>Shelter map site using Geodjango</em>
      </h3>
     
    </div>
    <div class="overlay"></div>
  </header>

  <!-- About -->
  <section class="content-section bg-light" id="about">
    <div class="container text-center">
      <div class="row">
        <div class="col-lg-10 mx-auto">
          <h2>GeoDjangoを用いた避難所マップのデモサイトです。</h2>
          <p class="lead mb-5">This is a demo site for a shelter map using GeoDjango.</p>
          <a class="btn btn-dark btn-xl js-scroll-trigger w-170px" href="#services">構成要素</a>
          <a class="btn btn-dark btn-xl js-scroll-trigger w-170px" href="#function">機能概要</a>
          <a class="btn btn-dark btn-xl js-scroll-trigger w-170px" href="#map">避難所MAP</a>

        </div>
      </div>
    </div>
  </section>

  <!-- Services -->
  <section class="content-section bg-primary text-white text-center" id="services">
    <div class="container">
      <div class="content-section-heading">
        <h2 class="mb-5">構成要素</h2>
      </div>
      <div class="row">
        <div class="col-lg-3 col-md-6 mb-5 mb-lg-0">
          <span class="service-icon rounded-circle mx-auto mb-3">
            <i class="fas fa-mobile-alt"></i>
          </span>
          <h4>
            <strong>Django</strong>
          </h4>
          <p class="text-faded mb-0">Djangoバージョン3.x</p>
        </div>
        <div class="col-lg-3 col-md-6 mb-5 mb-lg-0">
          <span class="service-icon rounded-circle mx-auto mb-3">
            <i class="fas fa-database"></i>
          </span>
          <h4>
            <strong>PostgreSQL & <br>PostGis</strong>
          </h4>
          <p class="text-faded mb-0">PostgreSQL10+PostGis2.4</p>
        </div>
        <div class="col-lg-3 col-md-6 mb-5 mb-md-0">
          <span class="service-icon rounded-circle mx-auto mb-3">
            <i class="fab fa-google"></i>
          </span>
          <h4>
            <strong>Google Map API</strong>
          </h4>
          <p class="text-faded mb-0">
            Directions API<br>
            Maps Elevation API<br>
            Maps JavaScript API</p>
        </div>
        <div class="col-lg-3 col-md-6">
          <span class="service-icon rounded-circle mx-auto mb-3">
            <i class="fab fa-aws"></i>
          </span>
          <h4>
            <strong>AWS</strong>
          </h4>
          <p class="text-faded mb-0">EC2<br>Ubuntu18.04<br>Nnginx<br>Gunicorn</p>
        </div>
      </div>
    </div>
  </section>


  <!-- Portfolio -->
  <section class="content-section" id="function">
    <div class="container">
      <div class="content-section-heading text-center">
       <!-- <h3 class="text-secondary mb-0">Portfolio</h3>-->
        <h2 class="mb-5">機能概要</h2>
      </div>
      <div class="row no-gutters">
        <div class="col-lg-6">
          <a class="portfolio-item" href="#function">
            <span class="caption">
              <span class="caption-content">
                <p>現在地を自動取得</p>
                <p>Geolocation API で現在の位置情報を取得してGoogleMapにマーカーを表示。</p>
              </span>
            </span>
            <img class="img-fluid" src="{% static 'startbootstrap-stylish-portfolio-gh-pages/img/street-map.jpg' %}" alt="">
          </a>
        </div>
        <div class="col-lg-6">
          <a class="portfolio-item" href="#function">
            <span class="caption">
              <span class="caption-content">
                <p>避難所をマッピング</p>
                <p>G空間情報センターで公開されている指定緊急避難場所をGoogleMapにマーカー表示。
                </p>
              </span>
            </span>
            <img class="img-fluid" src="{% static 'startbootstrap-stylish-portfolio-gh-pages/img/street-map.jpg' %}" alt="">
          </a>
        </div>
        <div class="col-lg-6">
          <a class="portfolio-item" href="#function">
            <span class="caption">
              <span class="caption-content">
                <p>最短経路の表示</p>
                <p class="mb-0">避難所のマーカーをクリックすると現在地からの最短経路を表示。</p>
              </span>
            </span>
            <img class="img-fluid" src="{% static 'startbootstrap-stylish-portfolio-gh-pages/img/street-map.jpg' %}" alt="">
          </a>
        </div>
        <div class="col-lg-6">
          <a class="portfolio-item" href="#function">
            <span class="caption">
              <span class="caption-content">
                <p>移動距離の表示</p>
                <p class="mb-0">最短経路と合わせて移動距離(メートル)を表示。</p>
              </span>
            </span>
            <img class="img-fluid" src="{% static 'startbootstrap-stylish-portfolio-gh-pages/img/street-map.jpg' %}" alt="">
          </a>
        </div>
      </div>
    </div>
  </section>



  <!-- Map -->

  <div class="content-section-heading text-center">
    <!-- <h3 class="text-secondary mb-0">Portfolio</h3>-->
    <h2 class="mb-5">避難所MAP</h2>
  </div>


  <section class="content-section" id="map">
    <div class="container">
      <div class="content-section-heading text-center">
       <!-- <h3 class="text-secondary mb-0">Portfolio</h3>-->
       
      </div>


     
  <section id="contact" class="map">


    <div id="map"></div>
    <script>
    // Geolocation APIに対応している
    if (navigator.geolocation) {
      //alert("この端末では位置情報が取得できます");
      // Geolocation APIに対応していない
      } else {
        alert("この端末では位置情報が取得できません");
        }
    // 現在地取得処理
    function getPosition() {
      // 現在地を取得
      navigator.geolocation.getCurrentPosition(
        // 取得成功した場合
        function(position) {
          // alert("緯度:"+position.coords.latitude+",経度"+position.coords.longitude);
          //initMap(position.coords.latitude, position.coords.longitude);
          //initMap(position.coords.latitude, position.coords.longitude);  
          initMap(35.6386125,139.699006);
          },
          );
          }
    function initMap(lat, lng) {
      var marker = [];
      var infoWindow = [];
      center = {lat:lat, lng:lng}
      /* ルート検索を行う */
      var directionsService = new google.maps.DirectionsService();
      /* ルート検索の結果を表示するためのオブジェクトを生成 */
      var directionsRenderer = new google.maps.DirectionsRenderer(); 
      /* new google.maps.Map()でマップオブジェクトを生成 */
      var map = new google.maps.Map(document.getElementById('map'), {
        zoom: 16,
        center: center,
        mapTypeId: google.maps.MapTypeId.SATELLITE  //衛星写真デザインを指定
        });
      /* mapObj を DirectionsRendererオブジェクトのsetMap()を使って関連付け */
      directionsRenderer.setMap(map);
      marker = new google.maps.Marker({ // マーカーの追加
          position: center, // マーカーを立てる位置を指定
          map: map, // マーカーを立てる地図を指定
          icon: {
            url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
            scaledSize : new google.maps.Size(50, 50)
            }
            });
      infoWindow = new google.maps.InfoWindow({ // 吹き出しの追加
          content: '<div class="sample">現在地はここ！</div>' // 吹き出しに表示する内容
          });
      infoWindow.open(map, marker); // 吹き出しの表示(デフォルトで表示させる)
      // ここからDjangoのviews.pyからオブジェクトを取得してループ
      {% for shop in object_list %}
          marker[{{forloop.counter}}] = new google.maps.Marker({
            position: {lat:{{ shop.geom.y }},lng: {{ shop.geom.x }} },
            map: map
            });
          infoWindow[{{forloop.counter}}] = new google.maps.InfoWindow({ // 吹き出しの追加
              content: '<div>' + '{{shop.evacuation_site }}' + '</div>' // 吹き出しに表示する内容
              });
          markerEvent({{forloop.counter}}, {{ shop.geom.y }}, {{ shop.geom.x }}, lat, lng, '{{shop.evacuation_site}}'); // マーカーにクリックイベントを追加
      {% endfor %}
   
    // マーカーにクリックイベントを追加
    function markerEvent(i, lat, lng, c_lat, c_lng, location) {
      marker[i].addListener('click', function() { // マーカーをクリックしたとき
      /* 開始地点の座標を指定*/
      var start = new google.maps.LatLng(c_lat, c_lng); 
      /* 目的地点の座標を指定*/
      var goal = new google.maps.LatLng(lat, lng); 
      // 2地点間の距離を求める 
      var distance = Math.ceil(google.maps.geometry.spherical.computeDistanceBetween(start, goal));
      infoWindow[i] = new google.maps.InfoWindow({ // 吹き出しの追加
          content: '<div class="sample">' + location + '<br>' + '移動距離：' + distance + 'm' + '</div>' // 吹き出しに表示する内容
       });
      infoWindow[i].open(map, marker[i]); // 吹き出しの表示

      var request = { 
          origin: start, 
          destination: goal,
          travelMode: google.maps.TravelMode.WALKING
           }; 
      directionsService.route(request, function(result, status) { 
        /* ルート検索に成功したら以下の処理 */
        if (status == google.maps.DirectionsStatus.OK) { 
          /* ルートをマップ上に表示 */ 
          directionsRenderer.setDirections(result);
          }
          }); // end directionsService.route
          }); // end marker[i].addListener
          }   // end function markerEvent
          }   // end function initMap
  
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=<API_KEY>&callback=getPosition">
    </script>
  </section>

</div>
</section>


  <!-- Footer -->
  <footer class="footer text-center">
    <div class="container">
      <ul class="list-inline mb-5">
        <li class="list-inline-item">
          <a class="social-link rounded-circle text-white mr-3" href="#">
            <i class="icon-social-facebook"></i>
          </a>
        </li>
        <li class="list-inline-item">
          <a class="social-link rounded-circle text-white mr-3" href="#">
            <i class="icon-social-twitter"></i>
          </a>
        </li>
        <li class="list-inline-item">
          <a class="social-link rounded-circle text-white" href="#">
            <i class="icon-social-github"></i>
          </a>
        </li>
      </ul>
      <p class="text-muted small mb-0">Copyright &copy; Your Website 2019</p>
    </div>
  </footer>

  <!-- Scroll to Top Button-->
  <a class="scroll-to-top rounded js-scroll-trigger" href="#page-top">
    <i class="fas fa-angle-up"></i>
  </a>

  <!-- Bootstrap core JavaScript -->
  <script src="{% static 'startbootstrap-stylish-portfolio-gh-pages/vendor/jquery/jquery.min.js' %}"></script>
  <script src="{% static 'startbootstrap-stylish-portfolio-gh-pages/vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>

  <!-- Plugin JavaScript -->
  <script src="{% static 'startbootstrap-stylish-portfolio-gh-pages/vendor/jquery-easing/jquery.easing.min.js' %}"></script>

  <!-- Custom scripts for this template -->
  <script src="{% static 'startbootstrap-stylish-portfolio-gh-pages/js/stylish-portfolio.min.js' %}"></script>

</body>

</html>
